<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8">
<meta name="author" content="yunlong">
<meta name="format-detection" content="telephone=no" />
<meta name="viewport" content="width=device-width,initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
<title>微信游戏闹钟提醒</title>
<link rel="stylesheet" type="text/css" href="style.css">
<style type="text/css">

</style>
<script type="text/javascript" src="http://images.vxinyou.com/jsCommon/jquery-1.7.2.min.js"></script>
</head>
<body>
<script type="text/javascript">
    $(function(){
        var old = parseInt($('html').css('fontSize')); //  HTML 字体
        var sizeFn = function(){ 
            var w = $(window).width(),
                newSize = old * w / 750;
            $('html').css('fontSize', newSize + 'px');
        };
        sizeFn();
        $(window).on('resize', function(){sizeFn();});
    })
</script>
<div id="loading" class="loading"><div class="loadbox"><div class="loadlogo"></div><div class="loadbg"></div></div><div id="loadingNUM">加载中...</div></div>
<div class="warp">
    <a href="http://ml.vxinyou.com/index/" class="logo">魔力时代</a>
    <div class="mian">
        <div class="tit"><a id="switch"  href="javascript:;"></a></div>
        <ul id="list" class="list"></ul>
    </div>
</div>

<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script type="text/javascript">
    //http://ml.vxinyou.com/zt/tixing/
    $(function(){
        var e_key     = "noi0nir4"
            idArra    = [],
			isSwitch  = 0,
            openid    = "oIv2RjhcsZ7UsbTfqQtict-yXkCo";

        /*
        $.getScript('http://event.vxinyou.net/wechat/JsApi/openid?mp_name=molishd&random=' + Math.random(), function(script, textStatus) {
            if (textStatus == 'success') {
                if (wechat_open_id == '') {
                    location.href = wechat_login_url;
                } else {
                    openid = wechat_open_id;
        */
                    $("#loading").fadeOut();                  

                    //获取消息列表
                    $.get('http://event.vxinyou.net/activity/Subscription/get_message_list',{"e_key":e_key, "openid":openid},function(response){
                        if(response.success){
                            console.log(response.data);
                            $.each(response.data, function(index,value){ 
                                idArra.push(value.id);
                                $('#list').append('<li data-id='+ value.id +'><i></i><h4>' + value.title +'</h4><p>' + value.content +'</p></li>');  
                            });

                            //获取玩家订阅消息列表
                            $.get('http://event.vxinyou.net/activity/Subscription/get_user_list',{"e_key":e_key, "openid":openid},function(response){
                                if(response.success){                            
                                    $.each(response.data, function(index,value){  	
                                       for (var i = 0; i < $('#list li').length; i++) {
                                            if($('#list li').eq(i).data('id') == value.msg_id){
                                               $('#list li').eq(i).addClass('active'); 
                                            };
                                        }; 
										if(index == 2){
											$("#switch").addClass('active');
											isSwitch  = 1;
										}
										console.log( index );
                                    });
                                }
                            },'jsonp')

                            $("#list li").bind("touchstart",function(){                                
                                var id = $(this).data("id");
                                if($(this).hasClass('active')){
                                    idArra.push(id);
                                    $(this).removeClass('active');
                                    cancelOrder(id);                                     
                                }else{
                                    idArra.splice($.inArray(id,idArra),1);
                                   $(this).addClass('active');
                                    submitOrder(id);  
                                };
                            });
                        }else{
                            alert(response.message);
                        }
                    },"jsonp");
					
					

					$("#switch").on('touchstart',function(){
						if(isSwitch == 0){
							console.log('一键订阅' + idArra.toString());
							submitOrder(idArra.toString())
							$(this).addClass('active');
							$('#list li').addClass('active');				
							isSwitch = 1;
						}else{
							cancelOrder(idArra.toString())
							console.log('一键取消' + idArra.toString());
							$(this).removeClass('active');
							$('#list li').removeClass('active');
							isSwitch = 0;
						}
					});
					
					/*
                    $('#switch').toggle(function(){
                        console.log('一键订阅' + idArra.toString());
                        submitOrder(idArra.toString())
                        $(this).addClass('active');
                        $('#list li').addClass('active');                        
                    },function(){                        
                        cancelOrder(idArra.toString())
                        console.log('一键取消' + idArra.toString());
                        $(this).removeClass('active');
                        $('#list li').removeClass('active');
                    });
					*/

                    function submitOrder(msg_id){
                       $.get('http://event.vxinyou.net/activity/Subscription/submit_user',{"e_key":e_key, "openid":openid, 'msg_id':msg_id},function(response){
                            console.log('提交订阅'+msg_id)
                       },'jsonp') 
                    };

                    function cancelOrder(msg_id){
                       $.get('http://event.vxinyou.net/activity/Subscription/cancel_user',{"e_key":e_key, "openid":openid, 'msg_id':msg_id},function(response){
                            console.log('取消订阅'+msg_id)
                       },'jsonp') 
                    }; 


        /*            
                
                };
            }
            else
            {
                alert('加载微信用户open_id接口失败');
            }
        });
        */


    });

</script>
</body>
</html>